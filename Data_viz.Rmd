---
title: "Vizualization"
author: "Aud H. Halbritter"
date: "11/10/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

source("R/load_packages.R")

biomass <- read_csv("data/biomass/FunCaB_biomass_clean_2015-2021.csv")
iButtonData <- read_csv("data/climate/FunCaB_clean_soiltemperature_2015-2017.csv")
community <- read_csv("data/community/FunCaB_clean_composition_21-11-03.csv")


meta <- biomass %>% 
  distinct(siteID, treatment) %>% 
  mutate(treatment = factor(treatment, levels = c("B", "F", "G", "FB", "GB", "GF", "FGB")),
         biogeographic_zone = recode(siteID,
                             Ulvehaugen = "alpine",
                             Lavisdalen = "alpine",
                             Gudmedalen = "alpine",
                             Skjelingahaugen = "alpine",
                             Alrust = "sub.alpine",
                             Hogsete = "sub.alpine",
                             Rambera = "sub.alpine",
                             Veskre = "sub.alpine",
                             Fauske = "boreal",
                             Vikesland = "boreal",
                             Arhelleren = "boreal",
                             Ovstedalen = "boreal"),
        prep_level = recode(siteID,
                               Ulvehaugen = 1,
                               Lavisdalen = 2,
                               Gudmedalen = 3,
                               Skjelingahaugen = 4,
                               Alrust = 1,
                               Hogsete = 2,
                               Rambera = 3,
                               Veskre = 4,
                               Fauske = 1,
                               Vikesland = 2,
                               Arhelleren = 3,
                               Ovstedalen = 4),
        climate = paste0(biogeographic_zone, prep_level),
        climate = factor(climate, levels = c("boreal1", "boreal2", "boreal3", "boreal4", "sub.alpine1", "sub.alpine2", "sub.alpine3", "sub.alpine4", "alpine1", "alpine2", "alpine3", "alpine4")))

```



```{r biomass}

biomass_plot <-  biomass %>% 
  left_join(meta, by = c("siteID", "treatment")) %>% 
  ggplot(aes(x = treatment, y = biomass, fill = removed_fg)) +
  geom_col() +
  scale_fill_manual(name = "Functional group", values = c("orange", "purple", "limegreen")) +
  labs(x = "Removed functional group", y = "Biomass in g") +
  facet_grid(year ~ climate) +
  theme_bw() +
  theme(legend.position="top")

biomass_plot

```

```{r temp}
dailyTemperature <- iButtonData %>%
  filter(!is.na(soiltemperature)) %>%
  mutate(date = dmy(format(date_time, "%d.%b.%Y"))) %>%
  group_by(date, siteID, treatment) %>%
  summarise(n = n(),
            soiltemperature = mean(soiltemperature),
            max_temp = max(soiltemperature)) %>%
  # filter(n > threshold) %>%
  # select(-n, -sum)
  left_join(meta, by = c("siteID", "treatment"))


dailyTemperature %>%
  mutate(treatment = factor(treatment, levels = c("C", "B", "F", "G", "FB", "GB", "GF", "FGB")),
         biogeographic_zone = factor(biogeographic_zone, levels = c("boreal", "sub.alpine", "alpine"))) %>% 
  select(date, siteID, treatment, max_temp) %>%
  pivot_wider(names_from = treatment, values_from = max_temp) %>%
  pivot_longer(cols = -c(date, siteID, C), names_to = "treatment", values_to = "max_temp") %>%
  mutate(diff = C - max_temp) %>%
    # filter(treatment %in% c("C", "FGB"),
    #      prep_level == 4) %>%
  ggplot(aes(x = date, y = diff, colour = treatment)) +
  geom_line() +
  #scale_color_manual(values = c("limegreen", "darkgoldenrod4")) +
  facet_wrap(~ siteID) +
  theme_bw()

```


``` {r community}

community %>% 
  filter(treatment %in% c("C", "FB", "GB")) %>% 
  group_by(year, siteID, treatment, functionalGroup) %>% 
  summarise(sumcover = mean(sumcover, na.rm = TRUE)) %>% 
  ggplot(aes(x = year, y = sumcover, colour = treatment, linetype = functionalGroup)) +
  geom_line() +
  facet_wrap(~ siteID)





```




